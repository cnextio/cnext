FROM tbaltrushaitis/ubuntu-nodejs
WORKDIR /app
COPY . .
USER root

# base init
RUN apt-get update
RUN apt-get install -y wget && rm -rf /var/lib/apt/lists/*


ENV PATH="/root/miniconda3/bin:${PATH}"
ARG PATH="/root/miniconda3/bin:${PATH}"

RUN wget \
    https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    && mkdir /root/.conda \
    && bash Miniconda3-latest-Linux-x86_64.sh -b \
    && rm -f Miniconda3-latest-Linux-x86_64.sh 
RUN conda --version

ENV PATH /opt/conda/envs/py39/bin:$PATH
# Activate conda environment
RUN conda env create -f environment.yml
RUN /bin/bash -c "source activate py39"

WORKDIR /app/cyc-next-app/server

RUN npm update & npm cache clean --force
RUN npm install -g n
RUN n stable
RUN npm -version
RUN npm install -g node-gyp
RUN npm i --build-from-source

# Install git
RUN conda install -c anaconda git

RUN git clone https://kiwing:QTmTLMdSUT3HPSEQpe7N@bitbucket.org/robotdreamers/cycdataframe.git
RUN git clone -b deploy --single-branch https://kiwing:QTmTLMdSUT3HPSEQpe7N@bitbucket.org/robotdreamers/cnext_sample_projects.git

# RUN npm i --force
# RUN npm run build

# WORKDIR /app/cyc-next-app/
